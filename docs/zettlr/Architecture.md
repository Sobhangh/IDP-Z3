–-
title: Architecture
tags: 
Date: 20200924141802
–-

This document presents the technical architecture of the Interactive Consultant.

The Interactive Consultant is a web application with both client-side and server-side components.  The repository for the client side is [here](https://gitlab.com/krr/autoconfig3), and for the server-side [here](https://gitlab.com/krr/autoconfigz3).  Their respective README.md file has instructions on how to install and run them.  

The [REST.md](REST.md) file describes the format of the data exchanged between the client and the server.  The exchange of data while using the Interactive Consultant can be visualised in the developer mode of most browsers (Chrome, Mozilla, …).

Their respective TODO.txt, and CHANGELOG.md files contain what you would expect. We follow the principles of [keepachangelog.com](https://keepachangelog.com/en/1.0.0/).

## Server Architecture

The server is written in python 3.7.4, using the [Flask framework](https://flask.palletsprojects.com/en/1.1.x/).  Pages are served by [rest.py](https://gitlab.com/krr/autoconfigz3/blob/master/consultant/rest.py).  Static files are served from the [/static](https://gitlab.com/krr/autoconfigz3/tree/master/consultant/static) directory, including the compiled version of the client software.

At start-up, and every time the idp code is changed on the client, the idp code is sent to the /meta URL by the client.  The server responds with the list of symbols to be displayed.

After that, when the user clicks on a GUI element, information is sent to the /eval URL, and the server responds as necessary.  Computing the response involves:

1.  parsing the idp code and the info entered by the user,     
2.  converting it to the [Z3](https://theory.stanford.edu/~nikolaj/programmingz3.html) format, ([guide](https://ericpony.github.io/z3py-tutorial/guide-examples.htm))    
3.  calling the appropriate inference (see [API](https://docs.google.com/presentation/d/1BgXIJNZJD6YTAT5k5ZSMv4irMeMA9a41EnJsIO1eK9Y/edit?usp=sharing)),    
4.  formatting the response.

The call tree is documented by \*.png files in the /docs/settlr directory (not updated regularly).

The idp code is parsed using the [textx package](https://github.com/textX/textX), using [this grammar](https://gitlab.com/krr/autoconfigz3/blob/master/Idp/Idp.tx).  The conversion to the Z3 format is performed by the following passes over the abstract syntax tree generated by the parser:

1.  annotate the vocabulary nodes by resolving type names, and computing some derived info such as enumerated ranges (Vocabulary.annotate()) 
2.  annotate the vocabulary with the enumerations found in the structure part of the idp code, if any (Structure.annotate())    
3.  annotate the constraints, by linking symbols to their declaration in the vocabulary and computing the type of expressions (Theory.annotate());  
4.  annotate the definitions, compute their Clark’s completion     
5.  expand quantifiers in the theory, when possible (*.expand_quantifiers())    
6.  interpret predicates with functions that have an enumeration in the structure (*.interpret()); add justification branch for defined symbols (by instantiating definitions)    
7.  extract the subtences of the theory, for display (*.subtences())    
8.  convert to Z3, adding the type constraints not enforced by Z3 (*.translate())
    
In steps 4 and 5, the resulting formula is immediately simplified (by update_exprs() ), while keeping the annotations.  For performance reasons, the results of some functions is memoized (e.g. *.translate()).

The information given by the user is combined with the idp code (in Case.py), and the subtences are put in these categories with their associated Truth value:

* given: given by the user    
* universal: always true (or false), per idp code    
* consequences: consequences of user’s input according to theory    
* irrelevant: made irrelevant by user’s input    
* unknown  

The inferences on the knowledge base are (in inferences.py):

* propagation    
* model expansion    
* optimisation    
* explain    
* abstract
    
To facilitate the detection of regression, the /tests directory contains various idp theories, for which the tests/main.py computes various inferences and saves their results in the corresponding .z3 file.

## Client Architecture

The client side is written in [Typescript](https://www.typescriptlang.org/), using the [Angular](https://angular.io/) framework (version 7.1), and the [primeNG](https://www.primefaces.org/primeng/#/) library of widgets.  It uses the [Monaco editor](https://www.npmjs.com/package/ngx-monaco-editor). The interactions with the server are controlled by [idp.service.ts](https://gitlab.com/krr/autoconfig3/blob/master/src/services/idp.service.ts).  The [AppSettings file](https://gitlab.com/krr/autoconfig3/blob/master/src/services/AppSettings.ts) contains important settings, such as the location of the default idp code (normally in examples/specification.idp).

## Licences

The Interactive Consultant is published under the [GNU Affero GPL license](https://www.gnu.org/licenses/why-affero-gpl.en.html).    

The server software uses the following components:

* [Z3](https://github.com/Z3Prover/z3): [MIT license](https://github.com/Z3Prover/z3/blob/master/LICENSE.txt)    
* [Z3-solver](https://pypi.org/project/z3-solver/): MIT license    
* [Flask](https://pypi.org/project/Flask/): BSD License (BSD-3-Clause)    
* [flask_restful](https://pypi.org/project/Flask-RESTful/) : BSD license    
* [flask_cors](https://pypi.org/project/Flask-Cors/) : MIT license    
* [pycallgraph2](https://pypi.org/project/pycallgraph2/) : GNU GPLv2    
* [gunicorn](https://pypi.org/project/gunicorn/) : MIT license    
* [textx](https://pypi.org/project/textX/): MIT license
    
The client-side software uses the following components:

* [Angular](https://angular.io/): [MIT-style license](https://angular.io/license)    
* [PrimeNg](https://github.com/primefaces/primeng): [MIT license](https://github.com/primefaces/primeng/blob/master/LICENSE.md)    
* [ngx-monaco-editor](https://www.npmjs.com/package/ngx-monaco-editor): MIT license    
* [packery](https://www.npmjs.com/package/packery): GPL-3.0    
* [primeicons](https://www.npmjs.com/package/primeicons): MIT    
* [isotope-layout](https://www.npmjs.com/package/isotope-layout): GNU GPL-3.0    
* [isotope-packery](https://www.npmjs.com/package/isotope-packery): MIT    
* [core-js](https://www.npmjs.com/package/core-js): MIT    
* [dev](https://www.npmjs.com/package/dev): None    
* [git-describe](https://www.npmjs.com/package/git-describe): MIT    
* [rxjs](https://www.npmjs.com/package/rxjs): Apache 2.0    
* [tslib](https://www.npmjs.com/package/tslib): Apache 2.0    
* [zone.js](https://www.npmjs.com/package/zone.js): MIT
    